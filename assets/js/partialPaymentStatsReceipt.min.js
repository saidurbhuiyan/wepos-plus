(()=>{async function t(t,e){const a=new FormData;a.append("file",t,e);try{const t=await fetch(weposData.mediaUrl+"?search="+e,{method:"GET",headers:{"X-WP-Nonce":weposData.nonce}}),n=await t.json();if(n.length>0){const t=n[0].id;return await async function(t,e){try{const a=await fetch(weposData.mediaUrl+`/${t}`,{method:"POST",headers:{"X-WP-Nonce":weposData.nonce},body:e});return(await a.json()).source_url}catch(t){console.error("Error:",t)}}(t,a)}return await async function(t){try{const e=await fetch(weposData.mediaUrl,{method:"POST",headers:{"X-WP-Nonce":weposData.nonce},body:t});return(await e.json()).source_url}catch(t){console.error("Error:",t)}}(a)}catch(t){console.error("Error:",t)}}function e(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function a(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const a=new Date(t),n={"F j, Y":{year:"numeric",month:"long",day:"numeric"},"Y-m-d":{year:"numeric",month:"2-digit",day:"2-digit"},"m/d/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"d/m/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"M j, Y":{year:"numeric",month:"short",day:"numeric"},"jS F Y":{},"l, F j, Y":{},"D, M j, Y":{},"g:i a":{hour:"numeric",minute:"numeric",hour12:!0},"g:i A":{hour:"numeric",minute:"numeric",hour12:!0},"H:i":{hour:"2-digit",minute:"2-digit",hour12:!1},"H:i:s":{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}}[partialPaymentData.dateFormat]||{year:"numeric",month:"long",day:"numeric"};return new Intl.DateTimeFormat("en-US",null!=e?e:n).format(a)}jQuery(document).ready((function(n){n(".partial-payment-stats").on("click",(async function(i){var o,r;if(i.preventDefault(),!i.target.classList.contains("partial-receipt")&&!i.target.parentNode.classList.contains("partial-receipt"))return;let l={};const s=n(i.target.closest(".partial-receipt")),c=parseFloat(null!==(o=s.attr("data-partial-paid"))&&void 0!==o?o:0).toFixed(2),d=parseFloat(null!==(r=s.attr("data-partial-due"))&&void 0!==r?r:0).toFixed(2),p=s.attr("data-partial-payment-id"),{currentPayment:m,pastPayment:u}=function(t,e){const a=e.find((e=>parseInt(e.ID)===parseInt(t)));return a?{currentPayment:a,pastPayment:e.filter((e=>parseInt(e.ID)<parseInt(t))).reverse()}:{currentPayment:null,pastPayment:[]}}(p,partialPaymentData.partialPaymentStats),h=s.attr("data-action-type");try{l=await n.ajax({type:"POST",url:`${weposData.orderUrl}/${partialPaymentData.orderId}`,beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",weposData.nonce)}}),l.total_partial_paid=c,l.total_partial_due=d,l.current_payment=m,l.past_payment=u;(new DOMParser).parseFromString(partialPaymentData.settings.wepos_receipts.receipt_header,"text/html");await async function(n,i,o){var r,l;let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"generate-receipt";const{jsPDF:c}=window.jspdf,d=new c({orientation:"p",unit:"mm",format:"a4"});let p=20;d.setFontSize(8),d.setFont("Helvetica","normal");let m=p;n.billing&&[{condition:n.customer_id,text:"Customer ID: #"+n.customer_id},{condition:n.billing.first_name||n.billing.last_name,text:(n.billing.first_name||"")+" "+(n.billing.last_name||"")},{condition:n.billing.email,text:n.billing.email},{condition:n.billing.phone,text:"Phone: "+n.billing.phone},{condition:n.billing.nif,text:"NIF: "+n.billing.nif},{condition:n.billing.address_1,text:n.billing.address_1}].forEach((t=>{t.condition&&(p+=5,d.text(t.text,11,p))}));if(i.wepos_receipts&&i.wepos_receipts.receipt_header){const t=document.createElement("div");t.innerHTML=i.wepos_receipts.receipt_header.trim();const e=Array.from(t.querySelectorAll("p")).map((t=>t.textContent.trim()));e.length>0&&e.forEach((t=>{m+=5,d.text(t,198,m,{align:"right"})}))}p=(p<m?m:p)+10,d.text(`Order ID: #${n.id}`,11,p),d.text(`Order Date: ${new Date(n.date_created).toLocaleString()}`,198,p,{align:"right"}),p+=5,d.setLineDash([1,1],0),d.setLineWidth(0,5),d.line(10,p,200,p),p+=10,d.setFont("Helvetica","bold"),d.text("Product",11,p),d.text("Quantity",100,p,{align:"center"}),d.text("Price",198,p,{align:"right"});const u=null===(r=n.meta_data)||void 0===r||null===(l=r.find((t=>"_wepos_product_expiry_data"===t.key)))||void 0===l?void 0:l.value;n.line_items.forEach((t=>{var n;if(p+=5,d.setFont("Helvetica","bold"),d.text(t.name,11,p),d.setFont("Helvetica","normal"),d.text(`${t.quantity}`,100,p,{align:"center"}),d.text(e(t.subtotal),198,p,{align:"right"}),t.meta_data&&t.meta_data.length>0){p+=2,d.setFontSize(7);let e=12;t.meta_data.forEach((t=>{if(t.key.startsWith("pa_")){d.setTextColor(117,133,152),d.text(`${t.display_key}: `,e,p,{baseline:"top"});const a=d.getTextWidth(`${t.display_key}: `);d.setTextColor(0,0,0),d.text(`${t.display_value}`,e+a,p,{baseline:"top"});const n=d.getTextWidth(`${t.display_value}: `);e=e+a+n}}))}const i=null==u||null===(n=u.find((e=>parseInt(null==e?void 0:e.product_id)===parseInt(null==t?void 0:t.product_id))))||void 0===n?void 0:n.expiry;i&&(p+=7,d.setTextColor(117,133,152),d.text("Expiry: ",12,p),d.setTextColor(0,0,0),i.forEach((t=>{p+=5,d.text(`${t.quantity}x ${a(t.date,"d/m/Y")}`,14,p)})));const o=parseFloat(t.total),r=parseFloat(t.subtotal)-o;r>0&&(p+=5,d.setTextColor(117,133,152),d.text(`Discount: -${e(r.toFixed(2))}`,12,p)),d.setTextColor(0,0,0)}));const h=parseFloat(n.total)+parseFloat(n.discount_total);if(d.setFont("Helvetica","bold"),d.setFontSize(8),p+=10,d.text("Subtotal:",11,p),d.text(e(h.toFixed(2)),198,p,{align:"right"}),n.coupon_lines&&n.coupon_lines.length>0){const t=n.coupon_lines.some((t=>"fixed_product"===t.discount_type));p+=5,t?(d.text("Discount:",11,p),d.text(`-${e(n.discount_total)}`,198,p,{align:"right"})):n.coupon_lines.forEach((t=>{d.text("Discount:",11,p),d.text(`-${e(Math.abs(t.discount))}`,198,p,{align:"right"})}))}n.fee_lines&&n.fee_lines.length>0&&n.fee_lines.forEach((t=>{p+=5,d.text("Fee:",11,p),d.text(e(Math.abs(t.fee)),198,p,{align:"right"})})),n.total_tax>0&&(p+=5,d.text("Tax:",11,p),d.text(e(n.total_tax),198,p,{align:"right"})),p+=5,d.setFont("Helvetica","bold"),d.text("Order Total:",11,p),d.text(e(n.total),198,p,{align:"right"}),p+=10,d.setLineDash([1,1],0),d.setLineWidth(0,5),d.line(10,p,200,p),p+=10;let g=n.meta_data.find((t=>"_wepos_vendor_type"===t.key));if(g=g&&g.value?g.value:"regular",d.setFont("Helvetica","normal"),d.text("Vendor Type:",10,p),d.text(g.charAt(0).toUpperCase()+g.slice(1),198,p,{align:"right"}),p+=5,d.setFont("Helvetica","normal"),d.text("Payment method:",10,p),d.text(n.payment_method_title||"",198,p,{align:"right"}),p+=5,d.text("Payment Type:",10,p),d.text(n.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))?"Partial Payment":"Full Payment",198,p,{align:"right"}),p+=5,d.text("Payment Date:",10,p),d.text(a(n.current_payment.date_created),198,p,{align:"right"}),p+=5,d.setFont("Helvetica","bold"),d.text("Paid Amount:",10,p),d.text(e(parseFloat(n.current_payment.paid).toFixed(2)),198,p,{align:"right"}),n.past_payment&&n.past_payment.length>0&&(p+=10,d.setLineDash([1,1],0),d.setLineWidth(0,5),d.line(10,p,200,p),p+=10,d.setFont("Helvetica","bold"),d.text("Past Payments:",11,p),d.setFont("Helvetica","normal"),n.past_payment.forEach((t=>{p+=5,d.text(a(t.date_created),13,p),d.text(e(parseFloat(t.paid).toFixed(2)),198,p,{align:"right"})}))),p+=10,d.setLineDash([1,1],0),d.setLineWidth(0,5),d.line(10,p,200,p),p+=10,d.setFont("Helvetica","bold"),d.text("Total Paid:",10,p),d.text(e(n.total_partial_paid),198,p,{align:"right"}),"wepos_cash"===n.payment_method&&n.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))&&n.total_partial_due>0&&(p+=5,d.text("Total Due:",10,p),d.text(e(n.total_partial_due),198,p,{align:"right"})),n.total_partial_due<=0&&(p+=5,d.text("Payment Status:",10,p),d.text("Fully Paid",198,p,{align:"right"})),p+=25,d.setFont("Helvetica","normal"),d.setLineDash([]),d.setLineWidth(.2,5),d.line(8,p,28,p),d.text("Prepared by",10,p+4,{align:"left"}),d.setFont("Helvetica","normal"),d.setLineDash([]),d.setLineWidth(.2,5),d.line(90,p,110,p),d.text("Delivered by",100,p+4,{align:"center"}),d.setFont("Helvetica","normal"),d.setLineDash([]),d.setLineWidth(.2,5),d.line(180,p,200,p),d.text("Reviewed by",198,p+4,{align:"right"}),i.wepos_receipts&&i.wepos_receipts.receipt_footer){const t=d.internal.pageSize,e=t.height?t.height:t.getHeight(),a=document.createElement("div");a.innerHTML=i.wepos_receipts.receipt_footer.trim();const n=Array.from(a.querySelectorAll("p")).map((t=>t.textContent.trim()));n.length>0&&n.forEach((t=>{d.text(t,100,e-10,{align:"center"})}))}const y=d.output("blob"),_=await t(y,"receipt-order-"+n.id+"-"+o+".pdf");let x=_;"share-whatsapp"===s&&(x=`https://api.whatsapp.com/send?text=${encodeURIComponent("Check out Your Order Receipt: "+_)}`);"share-email"===s&&(x=`mailto:?subject=${encodeURIComponent("Your Order Receipt")}&body=${encodeURIComponent("Hello,\n\nPlease check out your order receipt attached: "+_)}`);window.open(x,"_blank")}(l,partialPaymentData.settings,p,h)}catch(t){console.log(t)}}))}))})();