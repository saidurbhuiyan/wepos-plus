(()=>{function t(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function e(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const a=new Date(t),i={"F j, Y":{year:"numeric",month:"long",day:"numeric"},"Y-m-d":{year:"numeric",month:"2-digit",day:"2-digit"},"m/d/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"d/m/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"M j, Y":{year:"numeric",month:"short",day:"numeric"},"jS F Y":{},"l, F j, Y":{},"D, M j, Y":{},"g:i a":{hour:"numeric",minute:"numeric",hour12:!0},"g:i A":{hour:"numeric",minute:"numeric",hour12:!0},"H:i":{hour:"2-digit",minute:"2-digit",hour12:!1},"H:i:s":{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}}[partialPaymentData.dateFormat]||{year:"numeric",month:"long",day:"numeric"};return new Intl.DateTimeFormat("en-US",null!=e?e:i).format(a)}jQuery(document).ready((function(a){a(".partial-payment-stats").on("click",(async function(i){var n,o;if(i.preventDefault(),!i.target.classList.contains("partial-receipt")&&!i.target.parentNode.classList.contains("partial-receipt"))return;let r={};const l=a(i.target.closest(".partial-receipt")),s=parseFloat(null!==(n=l.attr("data-partial-paid"))&&void 0!==n?n:0).toFixed(2),c=parseFloat(null!==(o=l.attr("data-partial-due"))&&void 0!==o?o:0).toFixed(2),d=l.attr("data-partial-payment-id"),{currentPayment:p,pastPayment:m}=function(t,e){const a=e.find((e=>parseInt(e.ID)===parseInt(t)));return a?{currentPayment:a,pastPayment:e.filter((e=>parseInt(e.ID)<parseInt(t))).reverse()}:{currentPayment:null,pastPayment:[]}}(d,partialPaymentData.partialPaymentStats),u=l.attr("data-action-type");try{r=await a.ajax({type:"POST",url:`${weposData.orderUrl}/${partialPaymentData.orderId}`,beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",weposData.nonce)}}),r.total_partial_paid=s,r.total_partial_due=c,r.current_payment=p,r.past_payment=m;(new DOMParser).parseFromString(partialPaymentData.settings.wepos_receipts.receipt_header,"text/html");await async function(a,i){var n,o;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"generate-receipt";const{jsPDF:l}=window.jspdf,s=new l({orientation:"p",unit:"mm",format:"a4"});let c=20;s.setFontSize(8),s.setFont("Helvetica","normal");let d=c;a.billing&&[{condition:a.customer_id,text:"Customer ID: #"+a.customer_id},{condition:a.billing.first_name||a.billing.last_name,text:(a.billing.first_name||"")+" "+(a.billing.last_name||"")},{condition:a.billing.email,text:a.billing.email},{condition:a.billing.phone,text:"Phone: "+a.billing.phone},{condition:a.billing.nif,text:"NIF: "+a.billing.nif},{condition:a.billing.address_1,text:a.billing.address_1}].forEach((t=>{t.condition&&(c+=5,s.text(t.text,11,c))}));if(i.wepos_receipts&&i.wepos_receipts.receipt_header){const t=document.createElement("div");t.innerHTML=i.wepos_receipts.receipt_header.trim();const e=Array.from(t.querySelectorAll("p")).map((t=>t.textContent.trim()));e.length>0&&e.forEach((t=>{d+=5,s.text(t,198,d,{align:"right"})}))}c=(c<d?d:c)+10,s.text(`Order ID: #${a.id}`,11,c),s.text(`Order Date: ${new Date(a.date_created).toLocaleString()}`,198,c,{align:"right"}),c+=5,s.setLineDash([1,1],0),s.setLineWidth(0,5),s.line(10,c,200,c),c+=10,s.setFont("Helvetica","bold"),s.text("Product",11,c),s.text("Quantity",100,c,{align:"center"}),s.text("Price",198,c,{align:"right"});const p=null===(n=a.meta_data)||void 0===n||null===(o=n.find((t=>"_wepos_product_expiry_data"===t.key)))||void 0===o?void 0:o.value;a.line_items.forEach((a=>{var i;if(c+=5,s.setFont("Helvetica","bold"),s.text(a.name,11,c),s.setFont("Helvetica","normal"),s.text(`${a.quantity}`,100,c,{align:"center"}),s.text(t(a.subtotal),198,c,{align:"right"}),a.meta_data&&a.meta_data.length>0){c+=2,s.setFontSize(7);let t=12;a.meta_data.forEach((e=>{if(e.key.startsWith("pa_")){s.setTextColor(117,133,152),s.text(`${e.display_key}: `,t,c,{baseline:"top"});const a=s.getTextWidth(`${e.display_key}: `);s.setTextColor(0,0,0),s.text(`${e.display_value}`,t+a,c,{baseline:"top"});const i=s.getTextWidth(`${e.display_value}: `);t=t+a+i}}))}const n=null==p||null===(i=p.find((t=>parseInt(null==t?void 0:t.product_id)===parseInt(null==a?void 0:a.product_id))))||void 0===i?void 0:i.expiry;n&&(c+=7,s.setTextColor(117,133,152),s.text("Expiry: ",12,c),s.setTextColor(0,0,0),n.forEach((t=>{c+=5,s.text(`${t.quantity}x ${e(t.date,"d/m/Y")}`,14,c)})));const o=parseFloat(a.total),r=parseFloat(a.subtotal)-o;r>0&&(c+=5,s.setTextColor(117,133,152),s.text(`Discount: -${t(r.toFixed(2))}`,12,c)),s.setTextColor(0,0,0)}));const m=parseFloat(a.total)+parseFloat(a.discount_total);if(s.setFont("Helvetica","bold"),s.setFontSize(8),c+=10,s.text("Subtotal:",11,c),s.text(t(m.toFixed(2)),198,c,{align:"right"}),a.coupon_lines&&a.coupon_lines.length>0){const e=a.coupon_lines.some((t=>"fixed_product"===t.discount_type));c+=5,e?(s.text("Discount:",11,c),s.text(`-${t(a.discount_total)}`,198,c,{align:"right"})):a.coupon_lines.forEach((e=>{s.text("Discount:",11,c),s.text(`-${t(Math.abs(e.discount))}`,198,c,{align:"right"})}))}a.fee_lines&&a.fee_lines.length>0&&a.fee_lines.forEach((e=>{c+=5,s.text("Fee:",11,c),s.text(t(Math.abs(e.fee)),198,c,{align:"right"})})),a.total_tax>0&&(c+=5,s.text("Tax:",11,c),s.text(t(a.total_tax),198,c,{align:"right"})),c+=5,s.setFont("Helvetica","bold"),s.text("Order Total:",11,c),s.text(t(a.total),198,c,{align:"right"}),c+=10,s.setLineDash([1,1],0),s.setLineWidth(0,5),s.line(10,c,200,c),c+=10;let u=a.meta_data.find((t=>"_wepos_vendor_type"===t.key));if(u=u.value||"regular",s.setFont("Helvetica","normal"),s.text("Vendor Type:",10,c),s.text(u.charAt(0).toUpperCase()+u.slice(1),198,c,{align:"right"}),c+=5,s.setFont("Helvetica","normal"),s.text("Payment method:",10,c),s.text(a.payment_method_title||"",198,c,{align:"right"}),c+=5,s.text("Payment Type:",10,c),s.text(a.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))?"Partial Payment":"Full Payment",198,c,{align:"right"}),c+=5,s.text("Payment Date:",10,c),s.text(e(a.current_payment.date_created),198,c,{align:"right"}),c+=5,s.setFont("Helvetica","bold"),s.text("Paid Amount:",10,c),s.text(t(parseFloat(a.current_payment.paid).toFixed(2)),198,c,{align:"right"}),a.past_payment&&a.past_payment.length>0&&(c+=10,s.setLineDash([1,1],0),s.setLineWidth(0,5),s.line(10,c,200,c),c+=10,s.setFont("Helvetica","bold"),s.text("Past Payments:",11,c),s.setFont("Helvetica","normal"),a.past_payment.forEach((a=>{c+=5,s.text(e(a.date_created),13,c),s.text(t(parseFloat(a.paid).toFixed(2)),198,c,{align:"right"})}))),c+=10,s.setLineDash([1,1],0),s.setLineWidth(0,5),s.line(10,c,200,c),c+=10,s.setFont("Helvetica","bold"),s.text("Total Paid:",10,c),s.text(t(a.total_partial_paid),198,c,{align:"right"}),"wepos_cash"===a.payment_method&&a.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))&&a.total_partial_due>0&&(c+=5,s.text("Total Due:",10,c),s.text(t(a.total_partial_due),198,c,{align:"right"})),a.total_partial_due<=0&&(c+=5,s.text("Payment Status:",10,c),s.text("Fully Paid",198,c,{align:"right"})),c+=25,s.setFont("Helvetica","normal"),s.setLineDash([]),s.setLineWidth(.2,5),s.line(8,c,28,c),s.text("Prepared by",10,c+4,{align:"left"}),s.setFont("Helvetica","normal"),s.setLineDash([]),s.setLineWidth(.2,5),s.line(90,c,110,c),s.text("Delivered by",100,c+4,{align:"center"}),s.setFont("Helvetica","normal"),s.setLineDash([]),s.setLineWidth(.2,5),s.line(180,c,200,c),s.text("Reviewed by",198,c+4,{align:"right"}),i.wepos_receipts&&i.wepos_receipts.receipt_footer){const t=s.internal.pageSize,e=t.height?t.height:t.getHeight(),a=document.createElement("div");a.innerHTML=i.wepos_receipts.receipt_footer.trim();const n=Array.from(a.querySelectorAll("p")).map((t=>t.textContent.trim()));n.length>0&&n.forEach((t=>{s.text(t,100,e-10,{align:"center"})}))}const h=s.output("blob"),g=URL.createObjectURL(h);let _=g;"share-whatsapp"===r&&(_=`https://api.whatsapp.com/send?text=${encodeURIComponent("Check out Your Order Receipt: "+g)}`);"share-email"===r&&(_=`mailto:?subject=${encodeURIComponent("Your Order Receipt")}&body=${encodeURIComponent("Hello,\n\nPlease check out your order receipt attached: "+g)}`);window.open(_,"_blank")}(r,partialPaymentData.settings,u)}catch(t){console.log(t)}}))}))})();