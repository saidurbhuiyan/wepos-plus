(()=>{async function t(t,e){const a=new FormData;a.append("file",t,e);try{const t=await fetch(weposData.mediaUrl+"?search="+e,{method:"GET",headers:{"X-WP-Nonce":weposData.nonce}}),n=await t.json();return n.length>0&&n[0].media_details.filesize===a.get("file").size?n[0].source_url:(n.length>0&&await async function(t){try{const e=await fetch(weposData.mediaUrl+` / ${t} ? force = true`,{method:"DELETE",headers:{"X-WP-Nonce":weposData.nonce}});return(await e.json()).deleted}catch(t){console.error("Error:",t)}}(n[0].id),await async function(t){try{const e=await fetch(weposData.mediaUrl,{method:"POST",headers:{"X-WP-Nonce":weposData.nonce},body:t});return(await e.json()).source_url}catch(t){console.error("Error:",t)}}(a))}catch(t){console.error("Error:",t)}}async function e(e,i,r,o="generate-receipt",l=null){const{jsPDF:s}=window.jspdf,c=new s({orientation:"p",unit:"mm",format:"a4"});let d=20;c.setFontSize(8),c.setFont("Helvetica","normal");let p=d;if(e.billing){[{condition:e.customer_id,text:"Customer ID: #"+e.customer_id},{condition:e.billing.first_name||e.billing.last_name,text:(e.billing.first_name||"")+" "+(e.billing.last_name||"")},{condition:e.billing.email,text:e.billing.email},{condition:e.billing.phone,text:"Phone: "+e.billing.phone},{condition:e.billing.nif,text:"NIF: "+e.billing.nif},{condition:e.billing.address_1,text:e.billing.address_1}].forEach((t=>{t.condition&&(d+=5,c.text(t.text,11,d))}))}if(i.wepos_receipts&&i.wepos_receipts.receipt_header){const t=document.createElement("div");t.innerHTML=i.wepos_receipts.receipt_header.trim();const e=Array.from(t.querySelectorAll("p")).map((t=>t.textContent.trim()));e.length>0&&e.forEach((t=>{p+=5,c.text(t,198,p,{align:"right"})}))}d=(d<p?p:d)+10,c.text(`Order ID: #${e.id}`,11,d),c.text(`Order Date: ${new Date(e.date_created).toLocaleString()}`,198,d,{align:"right"}),d+=5,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10,c.setFont("Helvetica","bold"),c.text("Product",11,d),c.text("Price",100,d,{align:"center"}),c.text("Quantity",145,d,{align:"center"}),c.text("Total",198,d,{align:"right"});const u=e.meta_data?.find((t=>"_wepos_product_expiry_data"===t.key))?.value;e.line_items.forEach((t=>{var i;if(c.setFontSize(8),d+=5,c.setFont("Helvetica","bold"),c.text(t.name,11,d),c.setFont("Helvetica","normal"),c.text(a(t.price),100,d,{align:"center"}),c.text(`${t.quantity}`,145,d,{align:"center"}),c.text(a(t.subtotal),198,d,{align:"right"}),c.setFontSize(7),t.meta_data&&t.meta_data.length>0){let e=12;t.meta_data.forEach((t=>{if(t.key.startsWith("pa_")){d+=2,c.setTextColor(117,133,152),c.text(`${t.display_key}: `,e,d,{baseline:"top"});const a=c.getTextWidth(`${t.display_key}: `);c.setTextColor(0,0,0),c.text(`${t.display_value}`,e+a,d,{baseline:"top"});const n=c.getTextWidth(`${t.display_value}: `);e=e+a+n}}))}const r=u?.find((e=>parseInt(e?.product_id)===parseInt(t?.product_id)))?.expiry;r&&(d+=7,c.setTextColor(117,133,152),c.text("Expiry: ",12,d),c.setTextColor(0,0,0),r.forEach((t=>{d+=5,c.text(`${t.quantity}x ${n(t.date,"d/m/Y")}`,14,d)})));const o=parseFloat(t.total),l=(parseFloat(t.subtotal)-o).toFixed(2),s=e.coupon_lines?.find((t=>parseFloat(t.discount)===parseFloat(l))),p=(null!==(i=s?.nominal_amount)&&void 0!==i?i:l/t.quantity).toFixed(2);l>0&&(d+=5,c.setTextColor(117,133,152),c.text("Discount: -"+(a(l)+(l!==p?" ("+t.quantity+"x"+p+")":"")),12,d)),c.setTextColor(0,0,0)}));const m=parseFloat(e.total)+parseFloat(e.discount_total);if(c.setFont("Helvetica","bold"),c.setFontSize(8),d+=10,c.text("Subtotal:",11,d),c.text(a(m.toFixed(2)),198,d,{align:"right"}),e.coupon_lines&&e.coupon_lines.length>0){const t=e.coupon_lines.some((t=>"fixed_product"===t.discount_type));d+=5,t?(c.text("Discount:",11,d),c.text(` - ${a(e.discount_total)}`,198,d,{align:"right"})):e.coupon_lines.forEach((t=>{c.text("Discount:",11,d),c.text(` - ${a(Math.abs(t.discount))}`,198,d,{align:"right"})}))}e.fee_lines&&e.fee_lines.length>0&&e.fee_lines.forEach((t=>{d+=5,c.text("Fee:",11,d),c.text(a(Math.abs(t.fee)),198,d,{align:"right"})})),e.total_tax>0&&(d+=5,c.text("Tax:",11,d),c.text(a(e.total_tax),198,d,{align:"right"})),d+=5,c.setFont("Helvetica","bold"),c.text("Order Total:",11,d),c.text(a(e.total),198,d,{align:"right"}),d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10;let h=e.meta_data.find((t=>"_wepos_vendor_type"===t.key));h=h&&h.value?h.value:"regular",c.setFont("Helvetica","normal"),c.text("Vendor Type:",10,d),c.text(h.charAt(0).toUpperCase()+h.slice(1),198,d,{align:"right"}),d+=5,c.setFont("Helvetica","normal"),c.text("Payment method:",10,d),c.text(e.current_payment.method||"Cash",198,d,{align:"right"}),d+=5,c.text("Payment Type:",10,d),c.text(e.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))?"Partial Payment":"Full Payment",198,d,{align:"right"}),d+=5,c.text("Payment Date:",10,d),c.text(n(e.current_payment.date_created),198,d,{align:"right"}),parseFloat(e.current_payment.paid)>0&&(d+=5,c.setFont("Helvetica","bold"),c.text("Paid Amount:",10,d),c.text(a(parseFloat(e.current_payment.paid).toFixed(2)),198,d,{align:"right"})),e.past_payment=e.past_payment.filter((t=>parseFloat(t.paid)>0)),e.past_payment&&e.past_payment.length>0&&(d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10,c.setFont("Helvetica","bold"),c.text("Past Payments:",11,d),c.setFont("Helvetica","normal"),e.past_payment.forEach((t=>{var e,i;d+=5,c.text(n(t.date_created)+" ("+(i=null!==(e=t.method)&&void 0!==e?e:"cash",String(i).charAt(0).toUpperCase()+String(i).slice(1)+")"),13,d),c.text(a(parseFloat(t.paid).toFixed(2)),198,d,{align:"right"})}))),e.total_refund>0&&(d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=5),e.refund>0&&(d+=5,c.text("Refunded:",11,d),c.text(a(e.refund),198,d,{align:"right"}));const g=parseFloat(e.total)-parseFloat(e.total_refund);e.total_refund>0&&(d+=5,c.text("Total Refunded:",11,d),c.text(a(e.total_refund),198,d,{align:"right"}),d+=5,c.text("Net Payment:",11,d),c.text(a(g),198,d,{align:"right"})),d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10;const _=parseFloat(e.total_partial_paid)>g?g:e.total_partial_paid;if(c.setFont("Helvetica","bold"),c.text("Total Paid:",10,d),c.text(a(_),198,d,{align:"right"}),"wepos_cash"===e.payment_method&&e.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))&&e.total_partial_due>0&&(d+=5,c.text("Total Due:",10,d),c.text(a(e.total_partial_due),198,d,{align:"right"})),e.total_partial_due<=0&&(d+=5,c.text("Payment Status:",10,d),c.text("Fully Paid",198,d,{align:"right"})),d+=25,c.setFont("Helvetica","normal"),c.setLineDash([]),c.setLineWidth(.2,5),c.line(8,d,28,d),c.text("Prepared by",10,d+4,{align:"left"}),c.setFont("Helvetica","normal"),c.setLineDash([]),c.setLineWidth(.2,5),c.line(90,d,110,d),c.text("Delivered by",100,d+4,{align:"center"}),c.setFont("Helvetica","normal"),c.setLineDash([]),c.setLineWidth(.2,5),c.line(180,d,200,d),c.text("Reviewed by",198,d+4,{align:"right"}),i.wepos_receipts&&i.wepos_receipts.receipt_footer){const t=c.internal.pageSize,e=t.height?t.height:t.getHeight(),a=document.createElement("div");a.innerHTML=i.wepos_receipts.receipt_footer.trim();const n=Array.from(a.querySelectorAll("p")).map((t=>t.textContent.trim()));n.length>0&&n.forEach((t=>{c.text(t,100,e-10,{align:"center"})}))}const y=c.output("blob"),x=await t(y,"receipt-order-"+e.id+"-"+r+".pdf");let f=x;if("share-whatsapp"===o){f=`https://api.whatsapp.com/send?text=${encodeURIComponent("Check out Your Order Receipt: "+x)}`,l&&""!==l&&(f+=`&phone=${l=l.replaceAll("+","")}`)}if("share-email"===o){f=`mailto:?subject=${encodeURIComponent("Your Order Receipt")}&body=${encodeURIComponent("Hello,\n\nPlease check out your order receipt attached: "+x)}`}window.open(f,"_blank")}function a(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function n(t,e=null){const a=new Date(t),n={"F j, Y":{year:"numeric",month:"long",day:"numeric"},"Y-m-d":{year:"numeric",month:"2-digit",day:"2-digit"},"m/d/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"d/m/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"M j, Y":{year:"numeric",month:"short",day:"numeric"},"jS F Y":{},"l, F j, Y":{},"D, M j, Y":{},"g:i a":{hour:"numeric",minute:"numeric",hour12:!0},"g:i A":{hour:"numeric",minute:"numeric",hour12:!0},"H:i":{hour:"2-digit",minute:"2-digit",hour12:!1},"H:i:s":{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}}[partialPaymentData.dateFormat]||{year:"numeric",month:"long",day:"numeric"};return new Intl.DateTimeFormat("en-US",null!=e?e:n).format(a)}jQuery(document).ready((function(t){t(".partial-payment-stats").on("click",(async function(a){var n,i,r,o;if(a.preventDefault(),!a.target.classList.contains("partial-receipt")&&!a.target.parentNode.classList.contains("partial-receipt"))return;let l=t(a.target.closest("#receipt-actions")),s=t(l.siblings("#generating-receipt"));s.show(),l.hide();let c={};const d=t(a.target.closest(".partial-receipt")),p=parseFloat(null!==(n=d.attr("data-partial-paid"))&&void 0!==n?n:0).toFixed(2),u=parseFloat(null!==(i=d.attr("data-partial-due"))&&void 0!==i?i:0).toFixed(2),m=d.attr("data-partial-payment-id"),{currentPayment:h,pastPayment:g}=function(t,e){const a=e.find((e=>parseInt(e.ID)===parseInt(t)));return a?{currentPayment:a,pastPayment:e.filter((e=>parseInt(e.ID)<parseInt(t))).sort(((t,e)=>parseInt(e.ID)-parseInt(t.ID)))}:{currentPayment:null,pastPayment:[]}}(m,partialPaymentData.partialPaymentStats),_=d.attr("data-action-type"),y=parseFloat(null!==(r=d.attr("data-partial-refund"))&&void 0!==r?r:0).toFixed(2),x=parseFloat(null!==(o=d.attr("data-partial-total-refund"))&&void 0!==o?o:0).toFixed(2);try{var f;c=await t.ajax({type:"POST",url:`${weposData.orderUrl}/${partialPaymentData.orderId}`,beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",weposData.nonce)}}),c.total_partial_paid=p,c.total_partial_due=u,c.current_payment=h,c.past_payment=g,c.refund=y,c.total_refund=x;(new DOMParser).parseFromString(partialPaymentData.settings.wepos_receipts.receipt_header,"text/html");let a=null!==(f=c.billing.phone)&&void 0!==f?f:"";if("share-whatsapp"===_&&(""===a||confirm("Do you want to use another phone number to send the receipt?"))){const t=prompt("Please enter the phone number with country code (example +351) to send the receipt:");t&&(a=t.replaceAll(/\s/g,""))}("share-whatsapp"!==_||"share-whatsapp"===_&&""!==a)&&await e(c,partialPaymentData.settings,m,_,a)}catch(t){console.log(t)}s.hide(),l.show()}))}))})();