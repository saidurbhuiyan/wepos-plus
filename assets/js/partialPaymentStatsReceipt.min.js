(()=>{async function t(t,e){const a=new FormData;a.append("file",t,e);try{const t=await fetch(weposData.mediaUrl+"?search="+e,{method:"GET",headers:{"X-WP-Nonce":weposData.nonce}}),n=await t.json();return n.length>0&&n[0].media_details.filesize===a.get("file").size?n[0].source_url:(n.length>0&&await async function(t){try{const e=await fetch(weposData.mediaUrl+`/${t}?force=true`,{method:"DELETE",headers:{"X-WP-Nonce":weposData.nonce}});return(await e.json()).deleted}catch(t){console.error("Error:",t)}}(n[0].id),await async function(t){try{const e=await fetch(weposData.mediaUrl,{method:"POST",headers:{"X-WP-Nonce":weposData.nonce},body:t});return(await e.json()).source_url}catch(t){console.error("Error:",t)}}(a))}catch(t){console.error("Error:",t)}}function e(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function a(t,e=null){const a=new Date(t),n={"F j, Y":{year:"numeric",month:"long",day:"numeric"},"Y-m-d":{year:"numeric",month:"2-digit",day:"2-digit"},"m/d/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"d/m/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"M j, Y":{year:"numeric",month:"short",day:"numeric"},"jS F Y":{},"l, F j, Y":{},"D, M j, Y":{},"g:i a":{hour:"numeric",minute:"numeric",hour12:!0},"g:i A":{hour:"numeric",minute:"numeric",hour12:!0},"H:i":{hour:"2-digit",minute:"2-digit",hour12:!1},"H:i:s":{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}}[partialPaymentData.dateFormat]||{year:"numeric",month:"long",day:"numeric"};return new Intl.DateTimeFormat("en-US",null!=e?e:n).format(a)}jQuery(document).ready((function(n){n(".partial-payment-stats").on("click",(async function(i){var r,o;if(i.preventDefault(),!i.target.classList.contains("partial-receipt")&&!i.target.parentNode.classList.contains("partial-receipt"))return;let l=n("#generating-receipt"),s=n("#receipt-actions");l.show(),s.hide();let c={};const d=n(i.target.closest(".partial-receipt")),p=parseFloat(null!==(r=d.attr("data-partial-paid"))&&void 0!==r?r:0).toFixed(2),m=parseFloat(null!==(o=d.attr("data-partial-due"))&&void 0!==o?o:0).toFixed(2),h=d.attr("data-partial-payment-id"),{currentPayment:u,pastPayment:g}=function(t,e){const a=e.find((e=>parseInt(e.ID)===parseInt(t)));return a?{currentPayment:a,pastPayment:e.filter((e=>parseInt(e.ID)<parseInt(t))).reverse()}:{currentPayment:null,pastPayment:[]}}(h,partialPaymentData.partialPaymentStats),y=d.attr("data-action-type");try{var _;c=await n.ajax({type:"POST",url:`${weposData.orderUrl}/${partialPaymentData.orderId}`,beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",weposData.nonce)}}),c.total_partial_paid=p,c.total_partial_due=m,c.current_payment=u,c.past_payment=g;(new DOMParser).parseFromString(partialPaymentData.settings.wepos_receipts.receipt_header,"text/html");let i=null!==(_=c.billing.phone)&&void 0!==_?_:"";if("share-whatsapp"===y&&""===i){const t=prompt("Please enter the phone number with country code (example +351) to send the receipt:");t&&(i=t.replaceAll(/\s/g,""))}("share-whatsapp"!==y||"share-whatsapp"===y&&""!==i)&&await async function(n,i,r,o="generate-receipt",l=null){const{jsPDF:s}=window.jspdf,c=new s({orientation:"p",unit:"mm",format:"a4"});let d=20;c.setFontSize(8),c.setFont("Helvetica","normal");let p=d;n.billing&&[{condition:n.customer_id,text:"Customer ID: #"+n.customer_id},{condition:n.billing.first_name||n.billing.last_name,text:(n.billing.first_name||"")+" "+(n.billing.last_name||"")},{condition:n.billing.email,text:n.billing.email},{condition:n.billing.phone,text:"Phone: "+n.billing.phone},{condition:n.billing.nif,text:"NIF: "+n.billing.nif},{condition:n.billing.address_1,text:n.billing.address_1}].forEach((t=>{t.condition&&(d+=5,c.text(t.text,11,d))}));if(i.wepos_receipts&&i.wepos_receipts.receipt_header){const t=document.createElement("div");t.innerHTML=i.wepos_receipts.receipt_header.trim();const e=Array.from(t.querySelectorAll("p")).map((t=>t.textContent.trim()));e.length>0&&e.forEach((t=>{p+=5,c.text(t,198,p,{align:"right"})}))}d=(d<p?p:d)+10,c.text(`Order ID: #${n.id}`,11,d),c.text(`Order Date: ${new Date(n.date_created).toLocaleString()}`,198,d,{align:"right"}),d+=5,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10,c.setFont("Helvetica","bold"),c.text("Product",11,d),c.text("Cost",100,d,{align:"center"}),c.text("Quantity",145,d,{align:"center"}),c.text("Total",198,d,{align:"right"});const m=n.meta_data?.find((t=>"_wepos_product_expiry_data"===t.key))?.value;n.line_items.forEach((t=>{if(d+=5,c.setFont("Helvetica","bold"),c.text(t.name,11,d),c.setFont("Helvetica","normal"),c.text(e(t.price),100,d,{align:"center"}),c.text(`${t.quantity}`,145,d,{align:"center"}),c.text(e(t.subtotal),198,d,{align:"right"}),t.meta_data&&t.meta_data.length>0){d+=2,c.setFontSize(7);let e=12;t.meta_data.forEach((t=>{if(t.key.startsWith("pa_")){c.setTextColor(117,133,152),c.text(`${t.display_key}: `,e,d,{baseline:"top"});const a=c.getTextWidth(`${t.display_key}: `);c.setTextColor(0,0,0),c.text(`${t.display_value}`,e+a,d,{baseline:"top"});const n=c.getTextWidth(`${t.display_value}: `);e=e+a+n}}))}const n=m?.find((e=>parseInt(e?.product_id)===parseInt(t?.product_id)))?.expiry;n&&(d+=7,c.setTextColor(117,133,152),c.text("Expiry: ",12,d),c.setTextColor(0,0,0),n.forEach((t=>{d+=5,c.text(`${t.quantity}x ${a(t.date,"d/m/Y")}`,14,d)})));const i=parseFloat(t.total),r=parseFloat(t.subtotal)-i,o=(r/t.quantity).toFixed(2);r>0&&(d+=5,c.setTextColor(117,133,152),c.text("Discount: -"+e(r.toFixed(2))+" ("+t.quantity+"x"+o+")",12,d)),c.setTextColor(0,0,0)}));const h=parseFloat(n.total)+parseFloat(n.discount_total);if(c.setFont("Helvetica","bold"),c.setFontSize(8),d+=10,c.text("Subtotal:",11,d),c.text(e(h.toFixed(2)),198,d,{align:"right"}),n.coupon_lines&&n.coupon_lines.length>0){const t=n.coupon_lines.some((t=>"fixed_product"===t.discount_type));d+=5,t?(c.text("Discount:",11,d),c.text(`-${e(n.discount_total)}`,198,d,{align:"right"})):n.coupon_lines.forEach((t=>{c.text("Discount:",11,d),c.text(`-${e(Math.abs(t.discount))}`,198,d,{align:"right"})}))}n.fee_lines&&n.fee_lines.length>0&&n.fee_lines.forEach((t=>{d+=5,c.text("Fee:",11,d),c.text(e(Math.abs(t.fee)),198,d,{align:"right"})})),n.total_tax>0&&(d+=5,c.text("Tax:",11,d),c.text(e(n.total_tax),198,d,{align:"right"})),d+=5,c.setFont("Helvetica","bold"),c.text("Order Total:",11,d),c.text(e(n.total),198,d,{align:"right"}),d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10;let u=n.meta_data.find((t=>"_wepos_vendor_type"===t.key));if(u=u&&u.value?u.value:"regular",c.setFont("Helvetica","normal"),c.text("Vendor Type:",10,d),c.text(u.charAt(0).toUpperCase()+u.slice(1),198,d,{align:"right"}),d+=5,c.setFont("Helvetica","normal"),c.text("Payment method:",10,d),c.text(n.payment_method_title||"",198,d,{align:"right"}),d+=5,c.text("Payment Type:",10,d),c.text(n.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))?"Partial Payment":"Full Payment",198,d,{align:"right"}),d+=5,c.text("Payment Date:",10,d),c.text(a(n.current_payment.date_created),198,d,{align:"right"}),d+=5,c.setFont("Helvetica","bold"),c.text("Paid Amount:",10,d),c.text(e(parseFloat(n.current_payment.paid).toFixed(2)),198,d,{align:"right"}),n.past_payment&&n.past_payment.length>0&&(d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10,c.setFont("Helvetica","bold"),c.text("Past Payments:",11,d),c.setFont("Helvetica","normal"),n.past_payment.forEach((t=>{d+=5,c.text(a(t.date_created),13,d),c.text(e(parseFloat(t.paid).toFixed(2)),198,d,{align:"right"})}))),d+=10,c.setLineDash([1,1],0),c.setLineWidth(0,5),c.line(10,d,200,d),d+=10,c.setFont("Helvetica","bold"),c.text("Total Paid:",10,d),c.text(e(n.total_partial_paid),198,d,{align:"right"}),"wepos_cash"===n.payment_method&&n.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))&&n.total_partial_due>0&&(d+=5,c.text("Total Due:",10,d),c.text(e(n.total_partial_due),198,d,{align:"right"})),n.total_partial_due<=0&&(d+=5,c.text("Payment Status:",10,d),c.text("Fully Paid",198,d,{align:"right"})),d+=25,c.setFont("Helvetica","normal"),c.setLineDash([]),c.setLineWidth(.2,5),c.line(8,d,28,d),c.text("Prepared by",10,d+4,{align:"left"}),c.setFont("Helvetica","normal"),c.setLineDash([]),c.setLineWidth(.2,5),c.line(90,d,110,d),c.text("Delivered by",100,d+4,{align:"center"}),c.setFont("Helvetica","normal"),c.setLineDash([]),c.setLineWidth(.2,5),c.line(180,d,200,d),c.text("Reviewed by",198,d+4,{align:"right"}),i.wepos_receipts&&i.wepos_receipts.receipt_footer){const t=c.internal.pageSize,e=t.height?t.height:t.getHeight(),a=document.createElement("div");a.innerHTML=i.wepos_receipts.receipt_footer.trim();const n=Array.from(a.querySelectorAll("p")).map((t=>t.textContent.trim()));n.length>0&&n.forEach((t=>{c.text(t,100,e-10,{align:"center"})}))}const g=c.output("blob"),y=await t(g,"receipt-order-"+n.id+"-"+r+".pdf");let _=y;"share-whatsapp"===o&&(_=`https://api.whatsapp.com/send?text=${encodeURIComponent("Check out Your Order Receipt: "+y)}`,l&&""!==l&&(_+=`&phone=${l=l.replaceAll("+","")}`));"share-email"===o&&(_=`mailto:?subject=${encodeURIComponent("Your Order Receipt")}&body=${encodeURIComponent("Hello,\n\nPlease check out your order receipt attached: "+y)}`);window.open(_,"_blank")}(c,partialPaymentData.settings,h,y,i)}catch(t){console.log(t)}l.hide(),s.show()}))}))})();