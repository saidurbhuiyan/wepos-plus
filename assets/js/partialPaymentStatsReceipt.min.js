(()=>{function t(t){return new Intl.NumberFormat("de-DE",{style:"currency",currency:"EUR"}).format(t)}function e(t){const e=new Date(t),a={"F j, Y":{year:"numeric",month:"long",day:"numeric"},"Y-m-d":{year:"numeric",month:"2-digit",day:"2-digit"},"m/d/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"d/m/Y":{year:"numeric",month:"2-digit",day:"2-digit"},"M j, Y":{year:"numeric",month:"short",day:"numeric"},"jS F Y":{},"l, F j, Y":{},"D, M j, Y":{},"g:i a":{hour:"numeric",minute:"numeric",hour12:!0},"g:i A":{hour:"numeric",minute:"numeric",hour12:!0},"H:i":{hour:"2-digit",minute:"2-digit",hour12:!1},"H:i:s":{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}}[partialPaymentData.dateFormat]||{year:"numeric",month:"long",day:"numeric"};return new Intl.DateTimeFormat("en-US",a).format(e)}jQuery(document).ready((function(a){a(".partial-payment-stats").on("click",(async function(i){var n,r;if(i.preventDefault(),!i.target.classList.contains("partial-receipt")&&!i.target.parentNode.classList.contains("partial-receipt"))return;let o={};const l=a(i.target.closest(".partial-receipt")),s=parseFloat(null!==(n=l.attr("data-partial-paid"))&&void 0!==n?n:0).toFixed(2),c=parseFloat(null!==(r=l.attr("data-partial-due"))&&void 0!==r?r:0).toFixed(2),d=l.attr("data-partial-payment-id"),{currentPayment:p,pastPayment:m}=function(t,e){const a=e.find((e=>parseInt(e.ID)===parseInt(t)));return a?{currentPayment:a,pastPayment:e.filter((e=>parseInt(e.ID)<parseInt(t))).reverse()}:{currentPayment:null,pastPayment:[]}}(d,partialPaymentData.partialPaymentStats);try{o=await a.ajax({type:"POST",url:`${weposData.orderUrl}/${partialPaymentData.orderId}`,beforeSend:function(t){t.setRequestHeader("X-WP-Nonce",weposData.nonce)}}),o.total_partial_paid=s,o.total_partial_due=c,o.current_payment=p,o.past_payment=m;(new DOMParser).parseFromString(partialPaymentData.settings.wepos_receipts.receipt_header,"text/html");await async function(a,i){var n,r;const{jsPDF:o}=window.jspdf,l=new o({orientation:"p",unit:"mm",format:"a4"});let s=20;l.setFontSize(8),l.setFont("Helvetica","normal");let c=s;a.billing&&[{condition:a.customer_id,text:"Customer ID: #"+a.customer_id},{condition:a.billing.first_name||a.billing.last_name,text:(a.billing.first_name||"")+" "+(a.billing.last_name||"")},{condition:a.billing.email,text:a.billing.email},{condition:a.billing.phone,text:"Phone: "+a.billing.phone},{condition:a.billing.nif,text:"NIF: "+a.billing.nif},{condition:a.billing.address_1,text:a.billing.address_1}].forEach((t=>{t.condition&&(s+=5,l.text(t.text,11,s))}));if(i.wepos_receipts&&i.wepos_receipts.receipt_header){const t=document.createElement("div");t.innerHTML=i.wepos_receipts.receipt_header.trim();const e=Array.from(t.querySelectorAll("p")).map((t=>t.textContent.trim()));e.length>0&&e.forEach((t=>{c+=5,l.text(t,198,c,{align:"right"})}))}s=(s<c?c:s)+10,l.text(`Order ID: #${a.id}`,11,s),l.text(`Order Date: ${new Date(a.date_created).toLocaleString()}`,198,s,{align:"right"}),s+=5,l.setLineDash([1,1],0),l.setLineWidth(0,5),l.line(10,s,200,s),s+=10,l.setFont("Helvetica","bold"),l.text("Product",11,s),l.text("Quantity",100,s,{align:"center"}),l.text("Price",198,s,{align:"right"});const d=null===(n=a.meta_data)||void 0===n||null===(r=n.find((t=>"_wepos_product_expiry_data"===t.key)))||void 0===r?void 0:r.value;a.line_items.forEach((e=>{var a;if(s+=5,l.setFont("Helvetica","bold"),l.text(e.name,11,s),l.setFont("Helvetica","normal"),l.text(`${e.quantity}`,100,s,{align:"center"}),l.text(t(e.subtotal),198,s,{align:"right"}),e.meta_data&&e.meta_data.length>0){s+=2,l.setFontSize(7);let t=12;e.meta_data.forEach((e=>{if(e.key.startsWith("pa_")){l.setTextColor(117,133,152),l.text(`${e.display_key}: `,t,s,{baseline:"top"});const a=l.getTextWidth(`${e.display_key}: `);l.setTextColor(0,0,0),l.text(`${e.display_value}`,t+a,s,{baseline:"top"});const i=l.getTextWidth(`${e.display_value}: `);t=t+a+i}}))}const i=null==d||null===(a=d.find((t=>parseInt(null==t?void 0:t.product_id)===parseInt(null==e?void 0:e.product_id))))||void 0===a?void 0:a.expiry;i&&(s+=7,l.setTextColor(117,133,152),l.text("Expiry: ",12,s),l.setTextColor(0,0,0),i.forEach((t=>{s+=5,l.text(`${t.quantity}x ${t.date}`,14,s)})));const n=parseFloat(e.total),r=parseFloat(e.subtotal)-n;r>0&&(s+=5,l.setTextColor(117,133,152),l.text(`Discount: -${t(r.toFixed(2))}`,12,s)),l.setTextColor(0,0,0)}));const p=parseFloat(a.total)+parseFloat(a.discount_total);if(l.setFont("Helvetica","bold"),l.setFontSize(8),s+=10,l.text("Subtotal:",11,s),l.text(t(p.toFixed(2)),198,s,{align:"right"}),a.coupon_lines&&a.coupon_lines.length>0){const e=a.coupon_lines.some((t=>"fixed_product"===t.discount_type));s+=5,e?(l.text("Discount:",11,s),l.text(`-${t(a.discount_total)}`,198,s,{align:"right"})):a.coupon_lines.forEach((e=>{l.text("Discount:",11,s),l.text(`-${t(Math.abs(e.discount))}`,198,s,{align:"right"})}))}if(a.fee_lines&&a.fee_lines.length>0&&a.fee_lines.forEach((e=>{s+=5,l.text("Fee:",11,s),l.text(t(Math.abs(e.fee)),198,s,{align:"right"})})),a.total_tax>0&&(s+=5,l.text("Tax:",11,s),l.text(t(a.total_tax),198,s,{align:"right"})),s+=5,l.setFont("Helvetica","bold"),l.text("Order Total:",11,s),l.text(t(a.total),198,s,{align:"right"}),s+=10,l.setLineDash([1,1],0),l.setLineWidth(0,5),l.line(10,s,200,s),s+=10,l.setFont("Helvetica","normal"),l.text("Payment method:",10,s),l.text(a.payment_method_title||"",198,s,{align:"right"}),s+=5,l.text("Payment Type:",10,s),l.text(a.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))?"Partial Payment":"Full Payment",198,s,{align:"right"}),s+=5,l.text("Payment Date:",10,s),l.text(e(a.current_payment.date_created),198,s,{align:"right"}),s+=5,l.setFont("Helvetica","bold"),l.text("Paid Amount:",10,s),l.text(t(parseFloat(a.current_payment.paid).toFixed(2)),198,s,{align:"right"}),a.past_payment&&a.past_payment.length>0&&(s+=10,l.setLineDash([1,1],0),l.setLineWidth(0,5),l.line(10,s,200,s),s+=10,l.setFont("Helvetica","bold"),l.text("Past Payments:",11,s),l.setFont("Helvetica","normal"),a.past_payment.forEach((a=>{s+=5,l.text(e(a.date_created),13,s),l.text(t(parseFloat(a.paid).toFixed(2)),198,s,{align:"right"})}))),s+=10,l.setLineDash([1,1],0),l.setLineWidth(0,5),l.line(10,s,200,s),s+=10,l.setFont("Helvetica","bold"),l.text("Total Paid:",10,s),l.text(t(a.total_partial_paid),198,s,{align:"right"}),"wepos_cash"===a.payment_method&&a.meta_data.some((t=>"_wepos_cash_payment_type"===t.key&&"partial"===t.value))&&a.total_partial_due>0&&(s+=5,l.text("Total Due:",10,s),l.text(t(a.total_partial_due),198,s,{align:"right"})),a.total_partial_due<=0&&(s+=5,l.text("Payment Status:",10,s),l.text("Fully Paid",198,s,{align:"right"})),s+=25,l.setFont("Helvetica","normal"),l.setLineDash([]),l.setLineWidth(.2,5),l.line(8,s,28,s),l.text("Prepared by",10,s+4,{align:"left"}),l.setFont("Helvetica","normal"),l.setLineDash([]),l.setLineWidth(.2,5),l.line(90,s,110,s),l.text("Delivered by",100,s+4,{align:"center"}),l.setFont("Helvetica","normal"),l.setLineDash([]),l.setLineWidth(.2,5),l.line(180,s,200,s),l.text("Reviewed by",198,s+4,{align:"right"}),i.wepos_receipts&&i.wepos_receipts.receipt_footer){const t=l.internal.pageSize,e=t.height?t.height:t.getHeight(),a=document.createElement("div");a.innerHTML=i.wepos_receipts.receipt_footer.trim();const n=Array.from(a.querySelectorAll("p")).map((t=>t.textContent.trim()));n.length>0&&n.forEach((t=>{l.text(t,100,e-10,{align:"center"})}))}const m=l.output("blob"),u=URL.createObjectURL(m);window.open(u)}(o,partialPaymentData.settings)}catch(t){console.log(t)}}))}))})();